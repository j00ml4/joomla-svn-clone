<?xml version="1.0"?>
<chapter id="mvctutorial3">
  <chapterinfo>
    <author>
      <firstname>Ian</firstname>

      <surname>MacLennan</surname>
    </author>

    <date>March 5, 2007</date>
  </chapterinfo>

  <title>Developing a Model-View-Controller Component - Part 3 - Using the
  Database</title>

  <sect1 id="mvctutorial3.introduction">
    <title>Introduction</title>

    <para>In the first two tutorials, we showed you how to build a simple
    model-view-controller component. We had one view which retrieved data from
    a model (which was created in the 2nd tutorial). In this tutorial, we will
    be working with the model. Instead of the data being hard coded in the
    model, the model will retrieve the data from a table in the
    database.</para>

    <para>This tutorial will demonstrate how to use the JDatabase class to
    retrieve data from the database.</para>
  </sect1>

  <sect1 id="mvctutorial3.retrievingdata">
    <title>Retrieving the Data</title>

    <para>Our model currently has one method: getGreeting(). This method is
    very simple - all it does is return the hard-coded greeting.</para>

    <para>To make things more interesting, we will load the greeting from a
    database table. We will demonstrate later how to create an SQL file and
    add the appropriate code to the XML manifest file so that the table and
    some sample data will be created when the component is installed. For now,
    we will simply replace our return statement with some code that will
    retrieve the greeting from the database and return it.</para>

    <para>The first step is to obtain a reference to a database object. Since
    Joomla! uses the database for its normal operation, a database connection
    already exists; therefore, it is not necessary to create your own. A
    reference to the existing database can be obtained using:</para>

    <programlisting>$db =&amp; JFactory::getDBO();</programlisting>

    <para>JFactory is a static class that is used to retrieve references to
    many of the system objects. More information about this class can be found
    in the API documentation.</para>

    <para>The method name (getDBO) stands for get DataBase Object, and is easy
    and important to remember.</para>

    <para>Now that we have obtained a reference to the database object, we can
    retrieve our data. We do this in two steps:<orderedlist>
        <listitem>
          <para>store our query in the database object</para>

          <para>load the result</para>
        </listitem>
      </orderedlist></para>

    <para>Our new getGreeting() method will therefore look like:</para>

    <programlisting>function getGreeting()
{
   $db =&amp; JFactory::getDBO();

   $query = 'SELECT greeting FROM #__hello';
   $db-&gt;setQuery( $query );
   $greeting = $db-&gt;loadResult();

   return $greeting;
}</programlisting>

    <para>hello is the name of the table that we will create later, and
    greeting is the name of the field that stores the greetings. If you are
    not familiar with SQL, it would be helpful to take a tutorial or a lesson
    to get yourself up to speed. One such tutorial can be found at <ulink url="http://www.w3schools.com/sql/default.asp">w3schools</ulink>.</para>

    <para>The $db-&gt;loadResult() method will execute the stored database
    query and return the first field of the first row of the result. See
    [[references:joomla.framework:database:jdatabase|JDatabase API reference]]
    for more information about other load methods in the JDatabase
    class.</para>
  </sect1>

  <sect1 id="mvctutorial3.creatingsqlfile">
    <title>Creating the Installation SQL File</title>

    <para>The Joomla! installer has built-in support for executing queries
    during component installation. These queries are all stored in a standard
    text file.</para>

    <para>We will have three queries in our install file: the first will drop
    the table in case it already exists, the second will create the table with
    the appropriate fields, and the third will insert the data.</para>

    <para>Here are our queries:</para>

    <programlisting>DROP TABLE IF EXISTS `#__hello`;

CREATE TABLE `#__hello` (
  `id` int(11) NOT NULL auto_increment,
  `greeting` varchar(25) NOT NULL,
  PRIMARY KEY  (`id`)
) ENGINE=MyISAM AUTO_INCREMENT DEFAULT CHARSET=utf8;

INSERT INTO `#__hello` (`greeting`) VALUES ('Hello, World!'),
('Bonjour, Monde!'),
('Ciao, Mondo!');</programlisting>

    <para>You might find the #__ prefix on the table names rather odd. Joomla!
    will replace this prefix with the prefix used by the current install. For
    most installs, this table will become jos_hello. This allows multiple
    installs of Joomla! to use the same database, and prevents collisions with
    other applications using the same table names (i.e. two applications might
    share a database, but might both require a 'users' table. This convention
    avoids problems.)</para>

    <para>We have specified two fields in our database. The first field is id,
    and is called the 'primary key'. The primary key of a database table is a
    field that is used to uniquely identify a record. This is often used to
    lookup rows in the database. The other field is greeting. This is the
    field that stores the greeting that is returned from the query that we
    used above.</para>

    <para>We will save our queries in a file called install.sql.</para>

    <sect2 id="mvctutorial3.creatingsqlfile.uninstall">
      <title>Creating the Uninstall SQL File</title>

      <para>Though we might hope that people will never want to uninstall our
      component, it is important that if they do, we don't leave anything
      behind. Joomla! will look after deleting the files and directories that
      were created during install, but you must manually include queries that
      will remove and tables that have been added to the database. Since we
      have only created one table, we only need one query:</para>

      <programlisting>DROP TABLE IF EXISTS `#__hello`;</programlisting>

      <para>We will save this query in a file called
      <filename>uninstall.sql</filename>.</para>
    </sect2>
  </sect1>

  <sect1 id="mvctutorial3.updatinginstallfile">
    <title>Updating our Install File</title>

    <para>We need to change a few things in our install file. First, we need
    to add our two new files to the list of files to install. SQL install file
    have to go in the admin directory. Second, we need to tell the installer
    to execute the queries in our files on install and uninstall.</para>

    <para>Our new file looks like this:</para>

    <programlisting>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE install SYSTEM "http://dev.joomla.org/xml/1.5/component-install.dtd"&gt;
&lt;install type="component" version="1.5.0"&gt;
   &lt;name&gt;Hello&lt;/name&gt;
   &lt;!-- The following elements are optional and free of formatting conttraints --&gt;
   &lt;creationDate&gt;2007 02 22&lt;/creationDate&gt;
   &lt;author&gt;John Doe&lt;/author&gt;
   &lt;authorEmail&gt;john.doe@example.org&lt;/authorEmail&gt;
   &lt;authorUrl&gt;http://www.example.org&lt;/authorUrl&gt;
   &lt;copyright&gt;Copyright Info&lt;/copyright&gt;
   &lt;license&gt;License Info&lt;/license&gt;
   &lt;!--  The version string is recorded in the components table --&gt;
   &lt;version&gt;Component Version String&lt;/version&gt;
   &lt;!-- The description is optional and defaults to the name --&gt;
   &lt;description&gt;Description of the component ...&lt;/description&gt;

   &lt;!-- Site Main File Copy Section --&gt;
   &lt;files folder="site"&gt;
      &lt;filename&gt;index.html&lt;/filename&gt;
      &lt;filename&gt;hello.php&lt;/filename&gt;
      &lt;filename&gt;controller.php&lt;/filename&gt;
      &lt;filename&gt;views/index.html&lt;/filename&gt;
      &lt;filename&gt;views/hello/index.html&lt;/filename&gt;
      &lt;filename&gt;views/hello/view.html.php&lt;/filename&gt;
      &lt;filename&gt;views/hello/tmpl/index.html&lt;/filename&gt;
      &lt;filename&gt;views/hello/tmpl/default.php&lt;/filename&gt;
      &lt;filename&gt;models/hello.php&lt;/filename&gt;
   &lt;/files&gt;
   &lt;install&gt;
      &lt;sql&gt;
         &lt;file charset="utf8" driver="mysql"&gt;install.sql&lt;/file&gt;
      &lt;/sql&gt;
   &lt;/install&gt;
   &lt;uninstall&gt;
      &lt;sql&gt;
         &lt;file charset="utf8" driver="mysql"&gt;uninstall.sql&lt;/file&gt;
      &lt;/sql&gt;
   &lt;/uninstall&gt;   
   &lt;administration&gt;
      &lt;!-- Administration Menu Section --&gt;
      &lt;menu&gt;Hello World!&lt;/menu&gt;
      
      &lt;!-- Administration Main File Copy Section --&gt;
      &lt;!-- Note the folder attribute: This attribute describes the folder
         to copy FROM in the package to install therefore files copied
         in this section are copied from /admin/ in the package --&gt;
      &lt;files folder="admin"&gt;
   &lt;!-- Site Main File Copy Section --&gt;
         &lt;filename&gt;index.html&lt;/filename&gt;
         &lt;filename&gt;admin.hello.php&lt;/filename&gt;
         &lt;filename&gt;install.sql&lt;/filename&gt;
         &lt;filename&gt;uninstall.sql&lt;/filename&gt;
      &lt;/files&gt;      
   &lt;/administration&gt;
&lt;/install&gt;</programlisting>

    <para>You will notice two attributes present on the &lt;file&gt; tags
    within the &lt;install&gt; and &lt;uninstall&gt; sections: charset and
    driver. The charset is the type of charset to use. The only valid charset
    is utf8. If you want to create install files for non-utf8 databases (for
    older version of MySQL), you should omit this attribute.</para>

    <para>The driver attribute specifies which database the queries were
    written for. Currently, this can only be mysql, but in future versions of
    Joomla! there may be more database drivers available.</para>
  </sect1>

  <sect1 id="mvctutorial3.conclusion">
    <title>Conclusion</title>

    <para>We now have a component that takes advantage of both the Joomla! MVC
    framework classes and the JDatabase classes. You are now able to write MVC
    components that interact with the database and can use the Joomla!
    installer to create and populate database tables.</para>
  </sect1>

  <sect1 id="mvctutorial3.contributors">
    <title>Contributors</title>

    <simplelist>
      <member>staalanden</member>
    </simplelist>
  </sect1>

  <sect1 id="mvctutorial3.download">
    <title>Download</title>

    <para>The component can be downloaded at: <ulink url="packages/com_hello3.zip">com_hello3.zip</ulink></para>
  </sect1>
</chapter>
